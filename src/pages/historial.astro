---
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import Pagination from '@/components/shared/Pagination.astro';
import { getAllDiagnostics } from '@/services/homeService';
import { getAllPlots } from '@/services/plotService';

// @ts-expect-error - Bug conocido del LSP con Astro namespace
const currentPage = Number(Astro.url.searchParams.get('page')) || 1;
// @ts-expect-error - Bug conocido del LSP con Astro namespace
const severityFilter = Astro.url.searchParams.get('severity') || 'all';
// @ts-expect-error - Bug conocido del LSP con Astro namespace
const plotFilter = Astro.url.searchParams.get('plot') || 'all';
const itemsPerPage = 8;

let allDiagnostics = await getAllDiagnostics();
const allPlots = await getAllPlots();

if (severityFilter !== 'all') {
  allDiagnostics = allDiagnostics.filter(d => d.status === severityFilter);
}

if (plotFilter !== 'all') {
  allDiagnostics = allDiagnostics.filter(d => d.location === plotFilter);
}

const totalPages = Math.ceil(allDiagnostics.length / itemsPerPage);

const startIndex = (currentPage - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const paginatedDiagnostics = allDiagnostics.slice(startIndex, endIndex);

const totalItems = allDiagnostics.length;

const formatDate = (date: Date): string => {
  const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
  return `${date.getDate()} de ${months[date.getMonth()]}, ${date.getFullYear()}`;
};
---

<DashboardLayout title="Historial - Smart Potato Leaf" activeRoute="historial">
  <div class="space-y-6 sm:space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold text-state-idle">Historial de diagnóstico</h1>
      <div class="flex flex-col sm:flex-row gap-3">
        <a 
          href="#"
          class="inline-flex items-center justify-center gap-2 bg-white text-state-idle border border-outline px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors"
        >
          <i class="far fa-file-pdf"></i>
          Exportar a PDF
        </a>
        <a 
          href="#"
          class="inline-flex items-center justify-center gap-2 bg-white text-state-idle border border-outline px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors"
        >
          <i class="far fa-file-excel"></i>
          Exportar a CSV
        </a>
      </div>
    </div>

    <div class="bg-white rounded-lg border border-outline p-4 sm:p-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
        <div class="flex flex-col gap-1">
          <label class="text-xs text-state-disabled font-medium">De</label>
          <div class="relative">
            <input
              type="date"
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Sin fecha"
            />
            <i class="far fa-calendar absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none"></i>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-xs text-state-disabled font-medium">A</label>
          <div class="relative">
            <input
              type="date"
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Sin fecha"
            />
            <i class="far fa-calendar absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none"></i>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-xs text-state-disabled font-medium">Severidad</label>
          <div class="relative">
            <select
              name="severity"
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary appearance-none"
            >
              <option value="all" selected={severityFilter === 'all'}>Todas</option>
              <option value="healthy" selected={severityFilter === 'healthy'}>Sin rancha</option>
              <option value="low" selected={severityFilter === 'low'}>Rancha leve</option>
              <option value="moderate" selected={severityFilter === 'moderate'}>Rancha moderada</option>
              <option value="severe" selected={severityFilter === 'severe'}>Rancha severa</option>
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none text-xs"></i>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-xs text-state-disabled font-medium">Parcela</label>
          <div class="relative">
            <select
              name="plot"
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary appearance-none"
            >
              <option value="all" selected={plotFilter === 'all'}>Todas</option>
              {allPlots.map((plot) => (
                <option value={plot.name} selected={plotFilter === plot.name}>
                  {plot.name}
                </option>
              ))}
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none text-xs"></i>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end mb-4">
        <button
          type="button"
          class="inline-flex items-center gap-2 text-state-idle text-sm hover:underline"
        >
          <i class="fas fa-redo text-xs"></i>
          Restablecer filtros
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        {paginatedDiagnostics.length > 0 ? (
          paginatedDiagnostics.map((diagnostic) => (
            <div class="bg-gray-50 rounded-lg border border-outline overflow-hidden hover:shadow-md transition-shadow">
              <div class="aspect-square bg-gray-200 relative">
                <div class="absolute inset-0 flex items-center justify-center text-state-disabled">
                  <i class="fas fa-leaf text-4xl opacity-20"></i>
                </div>
              </div>
              <div class="p-3">
                <h3 class="font-semibold text-state-idle text-sm mb-2">
                  {diagnostic.statusLabel === 'Sin rancha' ? 'Hoja sana' : 'Hoja infectada'}
                </h3>
                <span class={`inline-block px-2 py-1 rounded text-xs font-medium mb-2 ${
                  diagnostic.status === 'healthy' ? 'bg-tag-healthy text-white' :
                  diagnostic.status === 'low' ? 'bg-tag-low text-state-idle' :
                  diagnostic.status === 'moderate' ? 'bg-tag-mid text-white' :
                  'bg-tag-severe text-white'
                }`}>
                  {diagnostic.statusLabel}
                </span>
                <p class="text-xs text-state-disabled mb-1">
                  <i class="fas fa-map-marker-alt mr-1"></i>
                  {diagnostic.location || 'Sin parcela'}
                </p>
                <p class="text-xs text-state-disabled mb-3">
                  {formatDate(diagnostic.predictedAt)}
                </p>
                <a 
                  href={`/diagnostico/${diagnostic.predictionId}`}
                  class="text-state-idle text-xs hover:underline inline-flex items-center gap-1"
                >
                  Ver detalles
                  <i class="fas fa-arrow-right text-xs"></i>
                </a>
              </div>
            </div>
          ))
        ) : (
          <div class="col-span-full text-center py-12">
            <i class="fas fa-inbox text-5xl text-state-disabled mb-4"></i>
            <p class="text-state-disabled">No hay diagnósticos que coincidan con los filtros</p>
          </div>
        )}
      </div>

      <div class="flex items-center justify-between pt-4 border-t border-outline">
        <p class="text-sm text-state-disabled">
          Mostrando {startIndex + 1} - {Math.min(endIndex, totalItems)} de {totalItems} diagnosticos
        </p>
        
        {totalPages > 1 && (
          <Pagination 
            currentPage={currentPage} 
            totalPages={totalPages}
            baseUrl="/historial"
          />
        )}
      </div>
    </div>
  </div>
</DashboardLayout>
