---
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import PlotForm from '@/components/plots/PlotForm';
---

<DashboardLayout 
  title="Nueva Parcela - Smart Potato Leaf" 
  description="Agregar nueva parcela de cultivo"
  activeRoute="parcelas"
>
  <div class="max-w-3xl mx-auto">
    <div class="mb-6">
      <a href="/plots" class="inline-flex items-center gap-2 text-primary hover:underline mb-4">
        <i class="fas fa-arrow-left"></i>
        Volver a mis parcelas
      </a>
      <h1 class="text-2xl sm:text-3xl font-bold text-state-idle mb-2">Nueva parcela</h1>
      <p class="text-state-disabled">Completa la información de tu nueva parcela</p>
    </div>

    <div class="bg-white rounded-lg border border-outline p-6">
      <PlotForm client:load />
    </div>
  </div>

  <script>
    import { addPlot } from '@/stores';
    import type { PlotFormData } from '@/components/plots/PlotForm';

    window.addEventListener('plot-form-submit', ((event: CustomEvent<PlotFormData>) => {
      const formData = event.detail;
      
      // TODO: En producción, hacer POST a la API
      // const response = await fetch('/api/plots', { method: 'POST', body: JSON.stringify(formData) });
      // const newPlot = await response.json();
      
      // Mock: crear plot con datos temporales
      const newPlot = {
        id: BigInt(Date.now()),
        name: formData.name,
        description: formData.description,
        variety: formData.variety,
        sector: formData.sector,
        create_at: new Date(),
        updated_at: new Date(),
        diagnosticsCount: 0,
        healthyCount: 0,
        infectedCount: 0,
      };

      addPlot(newPlot);
      window.location.href = '/plots';
    }) as EventListener);

    window.addEventListener('plot-form-cancel', () => {
      window.location.href = '/plots';
    });
  </script>
</DashboardLayout>
