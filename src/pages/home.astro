---
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import HomeDashboard from '@/components/home/HomeDashboard';
import AuthGuard from "@/components/shared/AuthGuard.tsx";
import {getDashboardStats, getRecentDiagnostics} from '@/services/homeService';

const stats = await getDashboardStats();
const recentDiagnostics = await getRecentDiagnostics();
---
<DashboardLayout title="Home - Smart Potato Leaf" activeRoute="home">
  <AuthGuard client:load>
    <HomeDashboard client:load/>
  </AuthGuard>
</DashboardLayout>

<script>
  import {setHomeData} from '@/stores';

  const homeData = document.getElementById('home-data');
  if (homeData) {
    const {stats, diagnostics} = JSON.parse(homeData.textContent || '{}', (key, value) => {
      if (key === 'predictionId' || key === 'imageId' || key === 'labelId') {
        return BigInt(value);
      }
      if (key === 'predictedAt' || key === 'uploadedAt') {
        return new Date(value);
      }
      return value;
    });
    setHomeData(stats, diagnostics);
  }
</script>

<script id="home-data" type="application/json"
        set:html={JSON.stringify({stats, diagnostics: recentDiagnostics}, (key, value) => {
          if (typeof value === 'bigint') {
            return value.toString();
          }
          if (value instanceof Date) {
            return value.toISOString();
          }
          return value;
        })}/>
