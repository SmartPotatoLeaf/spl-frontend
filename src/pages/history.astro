---
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import HistoryCard from '@/components/shared/HistoryCard.astro';
import Pagination from '@/components/shared/Pagination.astro';
import { getAllDiagnostics } from '@/services/homeService';
import { getAllPlots } from '@/services/plotService';

// @ts-expect-error - Bug conocido del LSP con Astro namespace
const currentPage = Number(Astro.url.searchParams.get('page')) || 1;
// @ts-expect-error - Bug conocido del LSP con Astro namespace
const severityFilter = Astro.url.searchParams.get('severity') || 'all';
// @ts-expect-error - Bug conocido del LSP con Astro namespace
const plotFilter = Astro.url.searchParams.get('plot') || 'all';
// @ts-expect-error - Bug conocido del LSP con Astro namespace
const dateFrom = Astro.url.searchParams.get('dateFrom') || '';
// @ts-expect-error - Bug conocido del LSP con Astro namespace
const dateTo = Astro.url.searchParams.get('dateTo') || '';
const itemsPerPage = 8;

let allDiagnostics = await getAllDiagnostics();
const allPlots = await getAllPlots();

// Filtrar por severidad
if (severityFilter !== 'all') {
  allDiagnostics = allDiagnostics.filter(d => d.status === severityFilter);
}

// Filtrar por parcela
if (plotFilter !== 'all') {
  allDiagnostics = allDiagnostics.filter(d => d.location === plotFilter);
}

// Filtrar por rango de fechas
if (dateFrom) {
  const fromDate = new Date(dateFrom);
  fromDate.setHours(0, 0, 0, 0);
  allDiagnostics = allDiagnostics.filter(d => {
    const diagDate = new Date(d.predictedAt);
    diagDate.setHours(0, 0, 0, 0);
    return diagDate >= fromDate;
  });
}

if (dateTo) {
  const toDate = new Date(dateTo);
  toDate.setHours(23, 59, 59, 999);
  allDiagnostics = allDiagnostics.filter(d => {
    const diagDate = new Date(d.predictedAt);
    return diagDate <= toDate;
  });
}

const totalPages = Math.ceil(allDiagnostics.length / itemsPerPage);

const startIndex = (currentPage - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const paginatedDiagnostics = allDiagnostics.slice(startIndex, endIndex);

const totalItems = allDiagnostics.length;
---

<DashboardLayout title="History - Smart Potato Leaf" activeRoute="history">
  <div class="space-y-6 sm:space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold text-state-idle">Historial de diagn贸stico</h1>
      <div class="flex flex-col sm:flex-row gap-3">
        <a 
          href="#"
          class="inline-flex items-center justify-center gap-2 bg-white text-state-idle border border-outline px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors"
        >
          <i class="far fa-file-pdf"></i>
          Exportar a PDF
        </a>
        <a 
          href="#"
          class="inline-flex items-center justify-center gap-2 bg-white text-state-idle border border-outline px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors"
        >
          <i class="far fa-file-excel"></i>
          Exportar a CSV
        </a>
      </div>
    </div>

    <form method="GET" action="/history" class="bg-white rounded-lg border border-outline p-4 sm:p-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
        <div class="flex flex-col gap-1">
          <label for="dateFrom" class="text-xs text-state-disabled font-medium">De</label>
          <div class="relative">
            <input
              type="date"
              id="dateFrom"
              name="dateFrom"
              value={dateFrom}
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary"
            />
            <i class="far fa-calendar absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none"></i>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label for="dateTo" class="text-xs text-state-disabled font-medium">A</label>
          <div class="relative">
            <input
              type="date"
              id="dateTo"
              name="dateTo"
              value={dateTo}
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary"
            />
            <i class="far fa-calendar absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none"></i>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label for="severity" class="text-xs text-state-disabled font-medium">Severidad</label>
          <div class="relative">
            <select
              id="severity"
              name="severity"
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary appearance-none"
            >
              <option value="all" selected={severityFilter === 'all'}>Todas</option>
              <option value="healthy" selected={severityFilter === 'healthy'}>Sin rancha</option>
              <option value="low" selected={severityFilter === 'low'}>Rancha leve</option>
              <option value="moderate" selected={severityFilter === 'moderate'}>Rancha moderada</option>
              <option value="severe" selected={severityFilter === 'severe'}>Rancha severa</option>
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none text-xs"></i>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label for="plot" class="text-xs text-state-disabled font-medium">Parcela</label>
          <div class="relative">
            <select
              id="plot"
              name="plot"
              class="w-full px-3 py-2 border border-outline rounded-lg text-sm text-state-idle focus:outline-none focus:ring-2 focus:ring-primary appearance-none"
            >
              <option value="all" selected={plotFilter === 'all'}>Todas</option>
              {allPlots.map((plot) => (
                <option value={plot.name} selected={plotFilter === plot.name}>
                  {plot.name}
                </option>
              ))}
            </select>
            <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-state-disabled pointer-events-none text-xs"></i>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between mb-4 gap-3">
        <button
          type="submit"
          class="inline-flex items-center gap-2 bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-opacity-90 transition-colors"
        >
          <i class="fas fa-filter text-xs"></i>
          Aplicar filtros
        </button>
        
        <a
          href="/history"
          class="inline-flex items-center gap-2 text-state-idle text-sm hover:underline"
        >
          <i class="fas fa-redo text-xs"></i>
          Restablecer filtros
        </a>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        {paginatedDiagnostics.length > 0 ? (
          paginatedDiagnostics.map((diagnostic) => (
            <HistoryCard diagnostic={diagnostic} />
          ))
        ) : (
          <div class="col-span-full text-center py-12">
            <i class="fas fa-inbox text-5xl text-state-disabled mb-4"></i>
            <p class="text-state-disabled">No hay diagn贸sticos que coincidan con los filtros</p>
          </div>
        )}
      </div>

      <div class="flex items-center justify-between pt-4 border-t border-outline">
        <p class="text-sm text-state-disabled">
          Mostrando {startIndex + 1} - {Math.min(endIndex, totalItems)} de {totalItems} diagn贸sticos
        </p>
        
        {totalPages > 1 && (
          <Pagination 
            currentPage={currentPage} 
            totalPages={totalPages}
            baseUrl={`/history?severity=${severityFilter}&plot=${plotFilter}&dateFrom=${dateFrom}&dateTo=${dateTo}`}
          />
        )}
      </div>
    </form>
  </div>
</DashboardLayout>

<script>
  // Validaci贸n de fechas en el cliente
  const dateFromInput = document.getElementById('dateFrom') as HTMLInputElement;
  const dateToInput = document.getElementById('dateTo') as HTMLInputElement;

  if (dateFromInput && dateToInput) {
    dateFromInput.addEventListener('change', () => {
      if (dateFromInput.value) {
        dateToInput.min = dateFromInput.value;
        
        // Si dateTo es anterior a dateFrom, limpiarlo
        if (dateToInput.value && dateToInput.value < dateFromInput.value) {
          dateToInput.value = '';
        }
      } else {
        dateToInput.removeAttribute('min');
      }
    });

    // Inicializar min si ya hay un valor en dateFrom
    if (dateFromInput.value) {
      dateToInput.min = dateFromInput.value;
    }
  }

  // Auto-submit al cambiar filtros (opcional)
  const form = document.querySelector('form');
  const selects = form?.querySelectorAll('select');
  
  selects?.forEach(select => {
    select.addEventListener('change', () => {
      form?.requestSubmit();
    });
  });
</script>
          </div>
        )}
      </div>

      <div class="flex items-center justify-between pt-4 border-t border-outline">
        <p class="text-sm text-state-disabled">
          Mostrando {startIndex + 1} - {Math.min(endIndex, totalItems)} de {totalItems} diagnosticos
        </p>
        
        {totalPages > 1 && (
          <Pagination 
            currentPage={currentPage} 
            totalPages={totalPages}
            baseUrl="/historial"
          />
        )}
      </div>
    </div>
  </div>
</DashboardLayout>
